# Kibitz Version Control (Commit & Rollback) Architecture

This document explains how commit, rollback, and GitHub push work in Kibitz, where the code lives, and how to evolve it toward a monorepo-ready structure without breaking current behavior.

## Overview

- Commit messages are generated by an LLM based on the staged diff, then committed locally and optionally pushed.
- Rollback supports UI-triggered hard reset to a chosen commit and service-level branch-based reverts.
- Git operations are executed via MCP Bash tooling with thread reuse for performance.

## Primary modules (current entrypoints)

- Version control facade (centralized)
  - `src/lib/versionControl/types.ts`: shared types for commit/rollback orchestration
  - `src/lib/versionControl/commit.ts`: `prepareCommit` (stage + diff + LLM), `executeCommit`, `pushCurrentBranch`
  - `src/lib/versionControl/rollback.ts`: `rollbackToCommit` (hard reset)
  - `src/lib/versionControl/index.ts`: barrel export
- Git plumbing and GitHub sync helpers
  - `src/lib/gitService.ts`: low-level Git exec, push utilities, remote connect/setup, GH checks
  - `git-executor.js`, `github-sync-manager.js`: node-side push orchestration used by sync routes
  - API routes: `src/app/api/github-sync/*` handle sync triggers/config/status
- LLM commit message generator
  - `src/lib/llmCommitMessageGenerator.ts`
- Orchestration/use sites
  - Auto-commit store: `src/stores/autoCommitStore.ts` (uses the facade + push)
  - Auto-commit hook: `src/components/LlmChat/hooks/useAutoCommit.ts`
  - Manual UI: `src/components/CommitRollbackControls.tsx` (uses facade rollback)
  - Conversation commit enrichment: `src/lib/enhancedConversationCommitService.ts`

## Legacy/auxiliary rollback and checkpoint modules (kept for compatibility)

- `src/lib/rollbackSystem.ts`: branch-based revert with backup/stash options
- `src/lib/checkpointRollbackService.ts`: checkpoint/rollback helpers (backup disabled by default)
- `src/lib/rollbackIntegrationService.ts`: DB-integrated rollback records
- `src/lib/enhancedBranchPersistence.ts`: in-memory rollback points
- `src/lib/gitSessionService.ts`: session-level rollback to a hash

These can be consolidated behind the facade in a later phase (see migration plan).

## End-to-end flows

### Auto-commit (triggered by tools/build/tests/file changes)

1) `useAutoCommit.ts` decides when to commit via `useAutoCommitStore().shouldAutoCommit`
2) `useAutoCommitStore().createLocalCommit`:
   - optionally creates a `conv-<id>-step-N` branch
   - calls `prepareCommit` → stages changes, gathers diff/numstat, gets LLM message
   - calls `executeCommit` → performs the commit via `gitService.createCommit`
3) Opportunistic push: `pushCurrentBranch`
4) Background enqueue of enhanced commit JSON and GitHub sync trigger

### Manual commit (UI)

- `src/components/CommitRollbackControls.tsx` performs an explicit commit (or can be updated to call the facade if desired)

### Rollback

- UI rollback (commit hash): `CommitRollbackControls.tsx` → `versionControl.rollbackToCommit` → `git reset --hard <hash>`
- Advanced branch-based rollback (optional): `rollbackSystem.ts` and `checkpointRollbackService.ts`

## Key environment/config

- Git identity for commits (one of):
  - Store vault: `useStore().apiKeys.githubUsername` and `githubEmail`
  - Env: `GIT_USER_NAME`, `GIT_USER_EMAIL` (or `NEXT_PUBLIC_*` variants)
- GitHub push:
  - Store vault token: `useStore().apiKeys.githubToken` (preferred)
  - Env: `GITHUB_TOKEN` or `GH_TOKEN` (fallback)
  - GitHub username: `useStore().apiKeys.githubUsername` or `gh api user --jq .login`
- Project settings flags (from `rootStore.projects[].settings`):
  - `enableGitHub` must be true for pushes and remote setup
  - LLM provider/model keys in project settings for commit messages

## Facade API (import from `@/lib/versionControl`)

- `prepareCommit(ctx): Promise<{ success, commitMessage, filesChanged, linesAdded, linesRemoved, diff?, error? }>`
  - Stages all changes, collects diff/numstat, generates LLM commit message
- `executeCommit(ctx, message): Promise<{ success, commitHash, message, error? }>`
  - Performs the actual `git commit` via `gitService`
- `pushCurrentBranch(projectPath, serverId, executeTool, explicitBranch?)`
  - Determines current branch and pushes via `gitService.pushToRemote`
- `rollbackToCommit({ projectPath, serverId, executeTool, commitHash })`
  - Hard resets to the given commit

## Current file responsibility map

- Commit
  - Message generation: `src/lib/llmCommitMessageGenerator.ts`
  - Orchestration: `src/lib/versionControl/commit.ts`, `src/stores/autoCommitStore.ts`
  - Low-level Git: `src/lib/gitService.ts`
- Push/sync
  - `src/lib/gitService.ts` → `pushToRemote`, `pushAllBranches`
  - `git-executor.js`, `github-sync-manager.js` (node-side) and API routes `src/app/api/github-sync/*`
- Rollback
  - UI hard reset: `src/lib/versionControl/rollback.ts`
  - Branch-based systems: `src/lib/rollbackSystem.ts`, `src/lib/checkpointRollbackService.ts`

## Monorepo-ready structure proposal (non-breaking)

Target layout (pnpm/yarn/npm workspaces):

```
/ (repo root)
  apps/
    web/                  # current Next.js app (move ./src here)
  packages/
    version-control/      # shared VC lib (facade + git + llm adapters)
    github-sync/          # node-only GH sync manager + executors
    mcp-adapter/          # thin MCP command executor wrapper
  docs/
    commit-rollback.md    # this document
  package.json            # workspaces config
```

Package split (phase 1):
- packages/version-control
  - exports facade: `prepareCommit`, `executeCommit`, `pushCurrentBranch`, `rollbackToCommit`
  - internal adapters to LLM and Git (re-exported from app code initially)
- packages/github-sync
  - move `git-executor.js`, `github-sync-manager.js`, sync APIs (or keep APIs in app and depend on this pkg)
- packages/mcp-adapter
  - minimal wrapper that standardizes MCP `Initialize` and `BashCommand` calls, plus thread reuse

App changes:
- apps/web depends on the above packages; current imports from `@/lib/versionControl` become `@kibitz/version-control`
- Keep legacy rollback modules in web app until fully migrated

Workspace config sketch (root package.json):

```json
{
  "private": true,
  "workspaces": ["apps/*", "packages/*"]
}
```

Migration steps (safe and incremental):
1) Move `src/lib/versionControl/*` to `packages/version-control/src/*` (no code changes)
2) Re-export `gitService`/`llmCommitMessageGenerator` via thin adapters in the package, or depend on them temporarily from `apps/web` using path exports
3) Replace in-app imports with `@kibitz/version-control`
4) Move `git-executor.js` and `github-sync-manager.js` into `packages/github-sync` and update API routes to import from the package
5) Finally, migrate advanced rollback services into the facade or mark deprecated

No behavior change required during the move; keep APIs identical.

## Deprecation plan (post-production hardening)

- Consolidate rollback logic under `version-control` and remove overlapping modules once fully covered:
  - Candidates to deprecate after consolidation: `rollbackSystem.ts`, `checkpointRollbackService.ts`, `enhancedBranchPersistence.ts`, `gitSessionService.ts`, `rollbackIntegrationService.ts`
- Keep old paths documented here for recovery:
  - `src/lib/rollbackSystem.ts`
  - `src/lib/checkpointRollbackService.ts`
  - `src/lib/rollbackIntegrationService.ts`
  - `src/lib/enhancedBranchPersistence.ts`
  - `src/lib/gitSessionService.ts`

## Testing checklist (before production)

- Auto-commit path:
  - triggers fire (tool, file, build, tests)
  - LLM commit message generated
  - commit created with identity configured
  - push succeeds when GitHub enabled
- Manual commit path (UI) still works
- Rollback:
  - UI rollback to a commit hash works (hard reset)
  - Optional: service-level branch rollback (if used) still intact
- GitHub sync:
  - config endpoint enables/disables sync
  - trigger endpoint pushes branches as expected

## Notes

- If any file is later removed during cleanup, use the old path list above and I can provide the original file back.
- The current facade centralizes all commit/rollback entrypoints; consumers should import from `@/lib/versionControl`.
